{"ast":null,"code":"import { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"F:\\\\MERN-Stack-Build-a-social-media-app\\\\client\\\\src\\\\components\\\\message\\\\RightSide.js\",\n    _s = $RefreshSig$();\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport UserCard from '../UserCard';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { useParams, useHistory } from 'react-router-dom';\nimport MsgDisplay from './MsgDisplay';\nimport Icons from '../Icons';\nimport { GLOBALTYPES } from '../../redux/actions/globalTypes';\nimport { imageShow, videoShow } from '../../utils/mediaShow';\nimport { imageUpload } from '../../utils/imageUpload';\nimport { addMessage, getMessages, loadMoreMessages, deleteConversation } from '../../redux/actions/messageAction';\nimport LoadIcon from '../../images/loading.gif';\n\nconst RightSide = () => {\n  _s();\n\n  const {\n    auth,\n    message,\n    theme,\n    socket,\n    peer\n  } = useSelector(state => state);\n  const dispatch = useDispatch();\n  const {\n    id\n  } = useParams();\n  const [user, setUser] = useState([]);\n  const [text, setText] = useState('');\n  const [media, setMedia] = useState([]);\n  const [loadMedia, setLoadMedia] = useState(false);\n  const refDisplay = useRef();\n  const pageEnd = useRef();\n  const [data, setData] = useState([]);\n  const [result, setResult] = useState(9);\n  const [page, setPage] = useState(0);\n  const [isLoadMore, setIsLoadMore] = useState(0);\n  const history = useHistory();\n  useEffect(() => {\n    const newData = message.data.find(item => item._id === id);\n\n    if (newData) {\n      setData(newData.messages);\n      setResult(newData.result);\n      setPage(newData.page);\n    }\n  }, [message.data, id]);\n  useEffect(() => {\n    if (id && message.users.length > 0) {\n      setTimeout(() => {\n        refDisplay.current.scrollIntoView({\n          behavior: 'smooth',\n          block: 'end'\n        });\n      }, 50);\n      const newUser = message.users.find(user => user._id === id);\n      if (newUser) setUser(newUser);\n    }\n  }, [message.users, id]);\n\n  const handleChangeMedia = e => {\n    const files = [...e.target.files];\n    let err = \"\";\n    let newMedia = [];\n    files.forEach(file => {\n      if (!file) return err = \"File does not exist.\";\n\n      if (file.size > 1024 * 1024 * 5) {\n        return err = \"The image/video largest is 5mb.\";\n      }\n\n      return newMedia.push(file);\n    });\n    if (err) dispatch({\n      type: GLOBALTYPES.ALERT,\n      payload: {\n        error: err\n      }\n    });\n    setMedia([...media, ...newMedia]);\n  };\n\n  const handleDeleteMedia = index => {\n    const newArr = [...media];\n    newArr.splice(index, 1);\n    setMedia(newArr);\n  };\n\n  const handleSubmit = async e => {\n    e.preventDefault();\n    if (!text.trim() && media.length === 0) return;\n    setText('');\n    setMedia([]);\n    setLoadMedia(true);\n    let newArr = [];\n    if (media.length > 0) newArr = await imageUpload(media);\n    const msg = {\n      sender: auth.user._id,\n      recipient: id,\n      text,\n      media: newArr,\n      createdAt: new Date().toISOString()\n    };\n    setLoadMedia(false);\n    await dispatch(addMessage({\n      msg,\n      auth,\n      socket\n    }));\n\n    if (refDisplay.current) {\n      refDisplay.current.scrollIntoView({\n        behavior: 'smooth',\n        block: 'end'\n      });\n    }\n  };\n\n  useEffect(() => {\n    const getMessagesData = async () => {\n      if (message.data.every(item => item._id !== id)) {\n        await dispatch(getMessages({\n          auth,\n          id\n        }));\n        setTimeout(() => {\n          refDisplay.current.scrollIntoView({\n            behavior: 'smooth',\n            block: 'end'\n          });\n        }, 50);\n      }\n    };\n\n    getMessagesData();\n  }, [id, dispatch, auth, message.data]); // Load More\n\n  useEffect(() => {\n    const observer = new IntersectionObserver(entries => {\n      if (entries[0].isIntersecting) {\n        setIsLoadMore(p => p + 1);\n      }\n    }, {\n      threshold: 0.1\n    });\n    observer.observe(pageEnd.current);\n  }, [setIsLoadMore]);\n  useEffect(() => {\n    if (isLoadMore > 1) {\n      if (result >= page * 9) {\n        dispatch(loadMoreMessages({\n          auth,\n          id,\n          page: page + 1\n        }));\n        setIsLoadMore(1);\n      }\n    } // eslint-disable-next-line\n\n  }, [isLoadMore]);\n\n  const handleDeleteConversation = () => {\n    if (window.confirm('Do you want to delete?')) {\n      dispatch(deleteConversation({\n        auth,\n        id\n      }));\n      return history.push('/message');\n    }\n  }; // Call\n\n\n  const caller = ({\n    video\n  }) => {\n    const {\n      _id,\n      avatar,\n      username,\n      fullname\n    } = user;\n    const msg = {\n      sender: auth.user._id,\n      recipient: _id,\n      avatar,\n      username,\n      fullname,\n      video\n    };\n    dispatch({\n      type: GLOBALTYPES.CALL,\n      payload: msg\n    });\n  };\n\n  const callUser = ({\n    video\n  }) => {\n    const {\n      _id,\n      avatar,\n      username,\n      fullname\n    } = auth.user;\n    const msg = {\n      sender: _id,\n      recipient: user._id,\n      avatar,\n      username,\n      fullname,\n      video\n    };\n    if (peer.open) msg.peerId = peer._id;\n    socket.emit('callUser', msg);\n  };\n\n  const handleAudioCall = () => {\n    caller({\n      video: false\n    });\n    callUser({\n      video: false\n    });\n  };\n\n  const handleVideoCall = () => {\n    caller({\n      video: true\n    });\n    callUser({\n      video: true\n    });\n  };\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"message_header\",\n      style: {\n        cursor: 'pointer'\n      },\n      children: user.length !== 0 && /*#__PURE__*/_jsxDEV(UserCard, {\n        user: user,\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          children: [/*#__PURE__*/_jsxDEV(\"i\", {\n            className: \"fas fa-phone-alt\",\n            onClick: handleAudioCall\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 189,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"i\", {\n            className: \"fas fa-video mx-3\",\n            onClick: handleVideoCall\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 192,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"i\", {\n            className: \"fas fa-trash text-danger\",\n            onClick: handleDeleteConversation\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 195,\n            columnNumber: 29\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 188,\n          columnNumber: 25\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 187,\n        columnNumber: 21\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat_container\",\n      style: {\n        height: media.length > 0 ? 'calc(100% - 180px)' : ''\n      },\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat_display\",\n        ref: refDisplay,\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          style: {\n            marginTop: '-25px',\n            opacity: 0\n          },\n          ref: pageEnd,\n          children: \"Load more\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 205,\n          columnNumber: 21\n        }, this), data.map((msg, index) => /*#__PURE__*/_jsxDEV(\"div\", {\n          children: [msg.sender !== auth.user._id && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"chat_row other_message\",\n            children: /*#__PURE__*/_jsxDEV(MsgDisplay, {\n              user: user,\n              msg: msg,\n              theme: theme\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 215,\n              columnNumber: 45\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 214,\n            columnNumber: 41\n          }, this), msg.sender === auth.user._id && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"chat_row you_message\",\n            children: /*#__PURE__*/_jsxDEV(MsgDisplay, {\n              user: auth.user,\n              msg: msg,\n              theme: theme,\n              data: data\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 222,\n              columnNumber: 45\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 221,\n            columnNumber: 41\n          }, this)]\n        }, index, true, {\n          fileName: _jsxFileName,\n          lineNumber: 211,\n          columnNumber: 33\n        }, this)), loadMedia && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat_row you_message\",\n          children: /*#__PURE__*/_jsxDEV(\"img\", {\n            src: LoadIcon,\n            alt: \"loading\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 233,\n            columnNumber: 28\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 232,\n          columnNumber: 24\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 204,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 202,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"show_media\",\n      style: {\n        display: media.length > 0 ? 'grid' : 'none'\n      },\n      children: media.map((item, index) => /*#__PURE__*/_jsxDEV(\"div\", {\n        id: \"file_media\",\n        children: [item.type.match(/video/i) ? videoShow(URL.createObjectURL(item), theme) : imageShow(URL.createObjectURL(item), theme), /*#__PURE__*/_jsxDEV(\"span\", {\n          onClick: () => handleDeleteMedia(index),\n          children: \"\\xD7\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 249,\n          columnNumber: 29\n        }, this)]\n      }, index, true, {\n        fileName: _jsxFileName,\n        lineNumber: 243,\n        columnNumber: 25\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 240,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n      className: \"chat_input\",\n      onSubmit: handleSubmit,\n      children: [/*#__PURE__*/_jsxDEV(\"input\", {\n        type: \"text\",\n        placeholder: \"Enter you message...\",\n        value: text,\n        onChange: e => setText(e.target.value),\n        style: {\n          filter: theme ? 'invert(1)' : 'invert(0)',\n          background: theme ? '#040404' : '',\n          color: theme ? 'white' : ''\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 256,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(Icons, {\n        setContent: setText,\n        content: text,\n        theme: theme\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 264,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"file_upload\",\n        children: [/*#__PURE__*/_jsxDEV(\"i\", {\n          className: \"fas fa-image text-danger\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 267,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n          type: \"file\",\n          name: \"file\",\n          id: \"file\",\n          multiple: true,\n          accept: \"image/*,video/*\",\n          onChange: handleChangeMedia\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 268,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 266,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        type: \"submit\",\n        className: \"material-icons\",\n        disabled: text || media.length > 0 ? false : true,\n        children: \"near_me\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 272,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 255,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true);\n};\n\n_s(RightSide, \"Z0sNB3UdCfamIbOLVz++IuYLd9s=\", false, function () {\n  return [useSelector, useDispatch, useParams, useHistory];\n});\n\n_c = RightSide;\nexport default RightSide;\n\nvar _c;\n\n$RefreshReg$(_c, \"RightSide\");","map":{"version":3,"sources":["F:/MERN-Stack-Build-a-social-media-app/client/src/components/message/RightSide.js"],"names":["React","useState","useEffect","useRef","UserCard","useSelector","useDispatch","useParams","useHistory","MsgDisplay","Icons","GLOBALTYPES","imageShow","videoShow","imageUpload","addMessage","getMessages","loadMoreMessages","deleteConversation","LoadIcon","RightSide","auth","message","theme","socket","peer","state","dispatch","id","user","setUser","text","setText","media","setMedia","loadMedia","setLoadMedia","refDisplay","pageEnd","data","setData","result","setResult","page","setPage","isLoadMore","setIsLoadMore","history","newData","find","item","_id","messages","users","length","setTimeout","current","scrollIntoView","behavior","block","newUser","handleChangeMedia","e","files","target","err","newMedia","forEach","file","size","push","type","ALERT","payload","error","handleDeleteMedia","index","newArr","splice","handleSubmit","preventDefault","trim","msg","sender","recipient","createdAt","Date","toISOString","getMessagesData","every","observer","IntersectionObserver","entries","isIntersecting","p","threshold","observe","handleDeleteConversation","window","confirm","caller","video","avatar","username","fullname","CALL","callUser","open","peerId","emit","handleAudioCall","handleVideoCall","cursor","height","marginTop","opacity","map","display","match","URL","createObjectURL","value","filter","background","color"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useRef } from 'react'\r\nimport UserCard from '../UserCard'\r\nimport { useSelector, useDispatch } from 'react-redux'\r\nimport { useParams, useHistory } from 'react-router-dom'\r\nimport MsgDisplay from './MsgDisplay'\r\nimport Icons from '../Icons'\r\nimport { GLOBALTYPES } from '../../redux/actions/globalTypes'\r\nimport { imageShow, videoShow } from '../../utils/mediaShow'\r\nimport { imageUpload } from '../../utils/imageUpload'\r\nimport { addMessage, getMessages, loadMoreMessages, deleteConversation } from '../../redux/actions/messageAction'\r\nimport LoadIcon from '../../images/loading.gif'\r\n\r\nconst RightSide = () => {\r\n    const { auth, message, theme, socket, peer } = useSelector(state => state)\r\n    const dispatch = useDispatch()\r\n\r\n    const { id } = useParams()\r\n    const [user, setUser] = useState([])\r\n    const [text, setText] = useState('')\r\n    const [media, setMedia] = useState([])\r\n    const [loadMedia, setLoadMedia] = useState(false)\r\n\r\n    const refDisplay = useRef()\r\n    const pageEnd = useRef()\r\n\r\n    const [data, setData] = useState([])\r\n    const [result, setResult] = useState(9)\r\n    const [page, setPage] = useState(0)\r\n    const [isLoadMore, setIsLoadMore] = useState(0)\r\n\r\n    const history = useHistory()\r\n\r\n    useEffect(() => {\r\n        const newData = message.data.find(item => item._id === id)\r\n        if(newData){\r\n            setData(newData.messages)\r\n            setResult(newData.result)\r\n            setPage(newData.page)\r\n        }\r\n    },[message.data, id])\r\n\r\n    useEffect(() => {\r\n        if(id && message.users.length > 0){\r\n            setTimeout(() => {\r\n                refDisplay.current.scrollIntoView({behavior: 'smooth', block: 'end'})\r\n            },50)\r\n\r\n            const newUser = message.users.find(user => user._id === id)\r\n            if(newUser) setUser(newUser)\r\n        }\r\n    }, [message.users, id])\r\n\r\n    const handleChangeMedia = (e) => {\r\n        const files = [...e.target.files]\r\n        let err = \"\"\r\n        let newMedia = []\r\n\r\n        files.forEach(file => {\r\n            if(!file) return err = \"File does not exist.\"\r\n\r\n            if(file.size > 1024 * 1024 * 5){\r\n                return err = \"The image/video largest is 5mb.\"\r\n            }\r\n\r\n            return newMedia.push(file)\r\n        })\r\n\r\n        if(err) dispatch({ type: GLOBALTYPES.ALERT, payload: {error: err} })\r\n        setMedia([...media, ...newMedia])\r\n    }\r\n\r\n    const handleDeleteMedia = (index) => {\r\n        const newArr = [...media]\r\n        newArr.splice(index, 1)\r\n        setMedia(newArr)\r\n    }\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault()\r\n        if(!text.trim() && media.length === 0) return;\r\n        setText('')\r\n        setMedia([])\r\n        setLoadMedia(true)\r\n\r\n        let newArr = [];\r\n        if(media.length > 0) newArr = await imageUpload(media)\r\n\r\n        const msg = {\r\n            sender: auth.user._id,\r\n            recipient: id,\r\n            text, \r\n            media: newArr,\r\n            createdAt: new Date().toISOString()\r\n        }\r\n\r\n        setLoadMedia(false)\r\n        await dispatch(addMessage({msg, auth, socket}))\r\n        if(refDisplay.current){\r\n            refDisplay.current.scrollIntoView({behavior: 'smooth', block: 'end'})\r\n        }\r\n    }\r\n\r\n    useEffect(() => {\r\n        const getMessagesData = async () => {\r\n            if(message.data.every(item => item._id !== id)){\r\n                await dispatch(getMessages({auth, id}))\r\n                setTimeout(() => {\r\n                    refDisplay.current.scrollIntoView({behavior: 'smooth', block: 'end'})\r\n                },50)\r\n            }\r\n        }\r\n        getMessagesData()\r\n    },[id, dispatch, auth, message.data])\r\n\r\n\r\n    // Load More\r\n    useEffect(() => {\r\n        const observer = new IntersectionObserver(entries => {\r\n            if(entries[0].isIntersecting){\r\n                setIsLoadMore(p => p + 1)\r\n            }\r\n        },{\r\n            threshold: 0.1\r\n        })\r\n\r\n        observer.observe(pageEnd.current)\r\n    },[setIsLoadMore])\r\n\r\n    useEffect(() => {\r\n        if(isLoadMore > 1){\r\n            if(result >= page * 9){\r\n                dispatch(loadMoreMessages({auth, id, page: page + 1}))\r\n                setIsLoadMore(1)\r\n            }\r\n        }\r\n        // eslint-disable-next-line\r\n    },[isLoadMore])\r\n\r\n    const handleDeleteConversation = () => {\r\n        if(window.confirm('Do you want to delete?')){\r\n            dispatch(deleteConversation({auth, id}))\r\n            return history.push('/message')\r\n        }\r\n    }\r\n\r\n    // Call\r\n    const caller = ({video}) => {\r\n        const { _id, avatar, username, fullname } = user\r\n\r\n        const msg = {\r\n            sender: auth.user._id,\r\n            recipient: _id, \r\n            avatar, username, fullname, video\r\n        }\r\n        dispatch({ type: GLOBALTYPES.CALL, payload: msg })\r\n    }\r\n\r\n    const callUser = ({video}) => {\r\n        const { _id, avatar, username, fullname } = auth.user\r\n\r\n        const msg = {\r\n            sender: _id,\r\n            recipient: user._id, \r\n            avatar, username, fullname, video\r\n        }\r\n\r\n        if(peer.open) msg.peerId = peer._id\r\n\r\n        socket.emit('callUser', msg)\r\n    }\r\n\r\n    const handleAudioCall = () => {\r\n        caller({video: false})\r\n        callUser({video: false})\r\n    }\r\n    \r\n    const handleVideoCall = () => {\r\n        caller({video: true})\r\n        callUser({video: true})\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <div className=\"message_header\" style={{cursor: 'pointer'}} >\r\n                {\r\n                    user.length !== 0 &&\r\n                    <UserCard user={user}>\r\n                        <div>\r\n                            <i className=\"fas fa-phone-alt\"\r\n                            onClick={handleAudioCall} />\r\n\r\n                            <i className=\"fas fa-video mx-3\"\r\n                            onClick={handleVideoCall} />\r\n\r\n                            <i className=\"fas fa-trash text-danger\"\r\n                            onClick={handleDeleteConversation} />\r\n                        </div>\r\n                    </UserCard>\r\n                }\r\n            </div>\r\n\r\n            <div className=\"chat_container\" \r\n            style={{height: media.length > 0 ? 'calc(100% - 180px)' : ''}} >\r\n                <div className=\"chat_display\" ref={refDisplay}>\r\n                    <button style={{marginTop: '-25px', opacity: 0}} ref={pageEnd}>\r\n                        Load more\r\n                    </button>\r\n\r\n                    {\r\n                        data.map((msg, index) => (\r\n                                <div key={index}>\r\n                                    {\r\n                                        msg.sender !== auth.user._id &&\r\n                                        <div className=\"chat_row other_message\">\r\n                                            <MsgDisplay user={user} msg={msg} theme={theme} />\r\n                                        </div>\r\n                                    }\r\n\r\n                                    {\r\n                                        msg.sender === auth.user._id &&\r\n                                        <div className=\"chat_row you_message\">\r\n                                            <MsgDisplay user={auth.user} msg={msg} theme={theme} data={data} />\r\n                                        </div>\r\n                                    }\r\n                                </div>\r\n                        ))\r\n                    }\r\n                    \r\n\r\n                   {\r\n                       loadMedia && \r\n                       <div className=\"chat_row you_message\">\r\n                           <img src={LoadIcon} alt=\"loading\"/>\r\n                       </div>\r\n                   }\r\n\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"show_media\" style={{display: media.length > 0 ? 'grid' : 'none'}} >\r\n                {\r\n                    media.map((item, index) => (\r\n                        <div key={index} id=\"file_media\">\r\n                            {\r\n                                item.type.match(/video/i)\r\n                                ? videoShow(URL.createObjectURL(item), theme)\r\n                                : imageShow(URL.createObjectURL(item), theme)\r\n                            }\r\n                            <span onClick={() => handleDeleteMedia(index)} >&times;</span>\r\n                        </div>\r\n                    ))\r\n                }\r\n            </div>\r\n\r\n            <form className=\"chat_input\" onSubmit={handleSubmit} >\r\n                <input type=\"text\" placeholder=\"Enter you message...\"\r\n                value={text} onChange={e => setText(e.target.value)}\r\n                style={{\r\n                    filter: theme ? 'invert(1)' : 'invert(0)',\r\n                    background: theme ? '#040404' : '',\r\n                    color: theme ? 'white' : ''\r\n                }} />\r\n\r\n                <Icons setContent={setText} content={text} theme={theme} />\r\n\r\n                <div className=\"file_upload\">\r\n                    <i className=\"fas fa-image text-danger\" />\r\n                    <input type=\"file\" name=\"file\" id=\"file\"\r\n                    multiple accept=\"image/*,video/*\" onChange={handleChangeMedia} />\r\n                </div>\r\n\r\n                <button type=\"submit\" className=\"material-icons\" \r\n                disabled={(text || media.length > 0) ? false : true}>\r\n                    near_me\r\n                </button>\r\n            </form>\r\n        </>\r\n    )\r\n}\r\n\r\nexport default RightSide\r\n"]},"metadata":{},"sourceType":"module"}